events {}

http {
  # Upstream for Messenger Service
  upstream messenger {
    server messenger-service-1:3001 max_fails=3 fail_timeout=30s;
    server messenger-service-2:3001 max_fails=3 fail_timeout=30s;
    server messenger-service-3:3001 max_fails=3 fail_timeout=30s;
    least_conn; # Load balance based on least connections
  }

  # Upstream for Profile Service
  upstream profile_servers {
    server profile-service-1:3004 max_fails=3 fail_timeout=30s;
    server profile-service-2:3004 max_fails=3 fail_timeout=30s;
    server profile-service-3:3004 max_fails=3 fail_timeout=30s;
    least_conn; # Load balance based on least connections
  }

  server {
    listen 80;
    server_name your_domain.com; # Replace with actual domain

    # Root location (Messenger Service)
    location / {
      proxy_pass http://messenger;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_connect_timeout 10s;
      proxy_read_timeout 15s;
      proxy_send_timeout 10s;
      proxy_buffer_size 8k;
      proxy_buffers 32 4k;
      proxy_busy_buffers_size 16k;
    }

    # Auth Service Location
    location /auth {
      proxy_pass http://auth-service:3000;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_connect_timeout 10s;
      proxy_read_timeout 15s;
      proxy_send_timeout 10s;
    }

    # Profile Service Location
    location /profile/ {
      proxy_pass http://profile_servers;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_connect_timeout 10s;
      proxy_read_timeout 15s;
      proxy_send_timeout 10s;
      proxy_buffer_size 8k;
      proxy_buffers 32 4k;
      proxy_busy_buffers_size 16k;
      # Optional health check
      health_check interval=30s fails=3 passes=2;
    }

    # Health Check Endpoint
    location /health {
      return 200 'healthy';
    }
  }

  # SSL Server Block
  server {
    listen 443 ssl;
    server_name your_domain.com; # Replace with actual domain

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # Root location (Messenger Service)
    location / {
      proxy_pass http://messenger;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_connect_timeout 10s;
      proxy_read_timeout 15s;
      proxy_send_timeout 10s;
    }

    # Auth Service Location
    location /auth {
      proxy_pass http://auth-service:3000;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_connect_timeout 10s;
      proxy_read_timeout 15s;
      proxy_send_timeout 10s;
    }

    # Profile Service Location
    location /profile/ {
      proxy_pass http://profile_servers;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_connect_timeout 10s;
      proxy_read_timeout 15s;
      proxy_send_timeout 10s;
      proxy_buffer_size 8k;
      proxy_buffers 32 4k;
      proxy_busy_buffers_size 16k;
      health_check interval=30s fails=3 passes=2;
    }

    # Health Check Endpoint
    location /health {
      return 200 'healthy';
    }
  }

  # Global settings (optional)
  client_max_body_size 10m; # Adjust upload size if needed
  error_page 500 502 503 504 /50x.html;
  location = /50x.html {
    root /usr/share/nginx/html;
  }
}